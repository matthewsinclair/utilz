name: Utilz Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-linux:
    name: Test on Ubuntu
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install bats-core
      run: |
        # Install bats-core v1.12.0 from GitHub
        wget https://github.com/bats-core/bats-core/archive/v1.12.0.tar.gz
        tar -xzf v1.12.0.tar.gz
        cd bats-core-1.12.0
        sudo ./install.sh /usr/local
        echo "PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
        which bats
        bats --version

    - name: Install dependencies
      run: |
        # Install yq for YAML parsing
        sudo apt-get update
        sudo apt-get install -y jq
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq
        yq --version

    - name: Set up Utilz
      run: |
        export UTILZ_HOME="${{ github.workspace }}"
        export PATH="$UTILZ_HOME/bin:$PATH"
        echo "UTILZ_HOME=$UTILZ_HOME" >> $GITHUB_ENV
        echo "$UTILZ_HOME/bin" >> $GITHUB_PATH
        chmod +x bin/utilz
        chmod +x opt/*/[!test]* 2>/dev/null || true

    - name: Run diagnostics
      run: |
        utilz doctor || echo "Doctor found issues (non-blocking)"
        utilz list
        utilz version

    - name: Run tests (excluding macoz - macOS only)
      run: |
        # Run all tests except macoz (macOS-only utility)
        for utility in utilz clipz cryptz gitz mdagg retry; do
          echo "Testing: $utility"
          utilz test $utility || exit 1
        done

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install bats-core
      run: |
        # Install bats with Homebrew
        brew install bats-core
        echo "PATH=$PATH:/usr/local/bin:/opt/homebrew/bin" >> $GITHUB_ENV
        which bats
        bats --version

    - name: Install dependencies
      run: |
        # Install yq for YAML parsing
        brew install yq
        yq --version

    - name: Set up Utilz
      run: |
        export UTILZ_HOME="${{ github.workspace }}"
        export PATH="$UTILZ_HOME/bin:$PATH"
        echo "UTILZ_HOME=$UTILZ_HOME" >> $GITHUB_ENV
        echo "$UTILZ_HOME/bin" >> $GITHUB_PATH
        chmod +x bin/utilz
        chmod +x opt/*/[!test]* 2>/dev/null || true

    - name: Run diagnostics
      run: |
        utilz doctor || echo "Doctor found issues (non-blocking)"
        utilz list
        utilz version

    - name: Run tests
      run: |
        utilz test

  shellcheck:
    name: Shell Script Analysis
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run ShellCheck
      run: |
        echo "Running ShellCheck on Utilz scripts..."
        # Run shellcheck on dispatcher
        if file bin/utilz | grep -q "shell script"; then
          echo "Checking: bin/utilz"
          shellcheck bin/utilz || echo "  ShellCheck found issues (non-blocking)"
        fi
        # Run shellcheck on utility implementations
        find opt -type f -executable -not -path "*/test/*" | while read -r script; do
          if file "$script" | grep -q "shell script"; then
            echo "Checking: $script"
            shellcheck "$script" || echo "  ShellCheck found issues (non-blocking)"
          fi
        done
        echo "ShellCheck analysis completed"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-linux, test-macos]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Test Summary"
        echo "All test jobs have completed."
        echo "Check individual job results above for details."

        # Check job results
        if [ "${{ needs.test-linux.result }}" == "success" ] && [ "${{ needs.test-macos.result }}" == "success" ]; then
          echo "All tests passed!"
        else
          echo "Some tests failed. Please review the logs."
          exit 1
        fi
