#!/usr/bin/env bash
#
# macoz - macOS system utilities
#

set -euo pipefail

# Source common functions if not already loaded (from dispatcher)
if [[ "$(type -t info 2>/dev/null)" != "function" ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    UTILZ_HOME="${UTILZ_HOME:-$(cd "$SCRIPT_DIR/../.." && pwd)}"

    if [[ -f "$UTILZ_HOME/opt/utilz/lib/common.sh" ]]; then
        source "$UTILZ_HOME/opt/utilz/lib/common.sh"
    else
        echo "ERROR: Cannot find common.sh library" >&2
        exit 1
    fi
fi

# ============================================================================
# PLATFORM CHECK
# ============================================================================

check_macos() {
    if [[ "$(uname)" != "Darwin" ]]; then
        error "macoz utilities require macOS"
        exit 1
    fi
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

get_season() {
    local month=$(date +%-m)

    case $month in
        3|4|5)
            echo "spring"
            ;;
        6|7|8)
            echo "summer"
            ;;
        9|10|11)
            echo "autumn"
            ;;
        12|1|2)
            echo "winter"
            ;;
    esac
}

get_seasonal_image() {
    local season=$(get_season)
    local images_dir="$UTILZ_HOME/opt/macoz/images/backgrounds"

    # Find all images for the current season
    local -a season_images
    while IFS= read -r -d '' image; do
        season_images+=("$image")
    done < <(find "$images_dir" -name "${season}-*.png" -print0 2>/dev/null)

    if [[ ${#season_images[@]} -eq 0 ]]; then
        error "No images found for season: $season"
        exit 1
    fi

    # Pick a random image
    local random_index=$((RANDOM % ${#season_images[@]}))
    echo "${season_images[$random_index]}"
}

# ============================================================================
# COMMANDS
# ============================================================================

cmd_background() {
    local arg1="${1:-}"
    local arg2="${2:-}"
    local image_path=""

    # Check if first arg is a season name
    if [[ "$arg1" =~ ^(spring|summer|autumn|winter)$ ]]; then
        local season="$arg1"
        local images_dir="$UTILZ_HOME/opt/macoz/images/backgrounds"

        if [[ -n "$arg2" ]]; then
            # Specific seasonal image requested
            image_path="$images_dir/${season}-${arg2}.png"
            if [[ ! -f "$image_path" ]]; then
                error "Seasonal image not found: ${season}-${arg2}.png"
                exit 1
            fi
            info "Selected $season wallpaper #$arg2"
        else
            # Random image from specified season
            local -a season_images
            while IFS= read -r -d '' image; do
                season_images+=("$image")
            done < <(find "$images_dir" -name "${season}-*.png" -print0 2>/dev/null)

            if [[ ${#season_images[@]} -eq 0 ]]; then
                error "No images found for season: $season"
                exit 1
            fi

            local random_index=$((RANDOM % ${#season_images[@]}))
            image_path="${season_images[$random_index]}"
            info "Random $season wallpaper selected"
        fi
    elif [[ -z "$arg1" ]]; then
        # No arguments - auto-select based on current season
        image_path=$(get_seasonal_image)
        local season=$(get_season)
        info "Auto-selected $season wallpaper"
    else
        # Custom image path provided
        image_path="$arg1"
    fi

    # Validate image exists
    if [[ ! -f "$image_path" ]]; then
        error "Image file not found: $image_path"
        exit 1
    fi

    # Convert to absolute path
    local absolute_path=$(cd "$(dirname "$image_path")" && pwd)/$(basename "$image_path")

    info "Setting desktop background to: $(basename "$absolute_path")"

    # Set background using osascript
    if osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"$absolute_path\""; then
        success "Desktop background updated"
    else
        error "Failed to set desktop background"
        exit 1
    fi
}

cmd_setpicfor() {
    local batch_mode=false
    local data_dir="."
    local pattern="icon.*|folder.*"
    local dry_run=false
    local verbose=false
    local image_path=""
    local target_dir=""

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                cat <<'EOFHELP'
Usage: macoz setpicfor <image> [directory]
       macoz setpicfor --all [options]

Set folder icon from image file.

ARGUMENTS:
  <image>      Path to image file (jpg, png)
  [directory]  Target directory (default: current directory)

OPTIONS:
  --all              Batch mode: set icons for subdirectories
  --data-dir <dir>   Directory to process (default: current)
  --pattern <pat>    Image pattern for --all mode
  --dry-run          Preview changes without applying
  -v, --verbose      Show detailed output
  -h, --help         Show this help

EXAMPLES:
  macoz setpicfor icon.png
  macoz setpicfor photo.jpg ~/Projects
  macoz setpicfor --all
  macoz setpicfor --all --dry-run --verbose

For more help: utilz help macoz
EOFHELP
                exit 0
                ;;
            --all)
                batch_mode=true
                shift
                ;;
            --data-dir)
                if [[ -z "${2:-}" ]]; then
                    error "No directory specified for --data-dir"
                    exit 1
                fi
                data_dir="$2"
                shift 2
                ;;
            --pattern)
                if [[ -z "${2:-}" ]]; then
                    error "No pattern specified for --pattern"
                    exit 1
                fi
                pattern="$2"
                shift 2
                ;;
            --dry-run)
                dry_run=true
                shift
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            -*)
                error "Unknown option: $1"
                exit 1
                ;;
            *)
                # Positional arguments
                if [[ -z "$image_path" ]]; then
                    image_path="$1"
                elif [[ -z "$target_dir" ]]; then
                    target_dir="$1"
                else
                    error "Too many arguments"
                    exit 1
                fi
                shift
                ;;
        esac
    done

    # Check for fileicon dependency
    if ! command -v fileicon >/dev/null 2>&1; then
        error "fileicon command not found"
        echo ""
        echo "Install with: brew install fileicon"
        exit 1
    fi

    if $batch_mode; then
        # Batch mode: scan directories for images matching pattern
        if [[ ! -d "$data_dir" ]]; then
            error "Directory not found: $data_dir"
            exit 1
        fi

        $verbose && info "Scanning directories in: $data_dir"
        $verbose && info "Image pattern: $pattern"

        local count=0
        # Find all subdirectories
        while IFS= read -r -d '' dir; do
            local dir_name=$(basename "$dir")

            # Look for image files matching pattern or directory name
            local found_image=""

            # First try exact pattern match
            for ext in png jpg jpeg PNG JPG JPEG; do
                if [[ -f "$dir/icon.$ext" ]]; then
                    found_image="$dir/icon.$ext"
                    break
                elif [[ -f "$dir/folder.$ext" ]]; then
                    found_image="$dir/folder.$ext"
                    break
                elif [[ -f "$dir/$dir_name.$ext" ]]; then
                    found_image="$dir/$dir_name.$ext"
                    break
                fi
            done

            if [[ -n "$found_image" ]]; then
                count=$((count + 1))
                if $dry_run; then
                    echo "[DRY RUN] Would set icon for: $dir"
                    echo "          Using image: $(basename "$found_image")"
                else
                    $verbose && info "Setting icon for: $dir"
                    if fileicon set "$dir" "$found_image" 2>&1; then
                        success "Set icon for: $dir"
                    else
                        warn "Failed to set icon for: $dir"
                    fi
                fi
            fi
        done < <(find "$data_dir" -mindepth 1 -maxdepth 1 -type d -print0)

        if [[ $count -eq 0 ]]; then
            warn "No directories with matching images found"
        else
            if $dry_run; then
                info "Would process $count directories"
            else
                success "Processed $count directories"
            fi
        fi
    else
        # Single directory mode
        if [[ -z "$image_path" ]]; then
            error "No image file specified"
            echo ""
            echo "Usage: macoz setpicfor <image> [directory]"
            exit 1
        fi

        # Default to current directory if not specified
        if [[ -z "$target_dir" ]]; then
            target_dir="."
        fi

        # Validate image exists
        if [[ ! -f "$image_path" ]]; then
            error "Image file not found: $image_path"
            exit 1
        fi

        # Validate directory exists
        if [[ ! -d "$target_dir" ]]; then
            error "Directory not found: $target_dir"
            exit 1
        fi

        # Convert to absolute paths
        local abs_image=$(cd "$(dirname "$image_path")" && pwd)/$(basename "$image_path")
        local abs_dir=$(cd "$target_dir" && pwd)

        $verbose && info "Image: $abs_image"
        $verbose && info "Directory: $abs_dir"

        if $dry_run; then
            echo "[DRY RUN] Would set icon for: $abs_dir"
            echo "          Using image: $(basename "$abs_image")"
        else
            info "Setting folder icon..."
            if fileicon set "$abs_dir" "$abs_image" 2>&1; then
                success "Folder icon updated: $abs_dir"
                echo ""
                echo "Note: You may need to restart Finder to see the changes:"
                echo "  killall Finder"
            else
                error "Failed to set folder icon"
                exit 1
            fi
        fi
    fi
}

# ============================================================================
# USAGE
# ============================================================================

usage() {
    cat <<EOF
Usage: macoz <command> [args]

macOS system utilities

COMMANDS:
  background [season] [id]  Set desktop background image
                            - No args: auto-select current seasonal wallpaper
                            - season: random wallpaper from specified season
                            - season id: specific seasonal wallpaper (e.g., autumn 02)
                            - image path: use custom image

  bg                        Alias for background

  setpicfor <image> [dir]   Set folder icon from image file
                            - image: path to image file (jpg, png)
                            - dir: target directory (default: current directory)
                            Options:
                              --all           Batch mode: set icons for subdirectories
                              --data-dir DIR  Directory to process (default: current)
                              --pattern PAT   Image pattern for --all mode
                              --dry-run       Preview changes without applying
                              -v, --verbose   Show detailed output

OPTIONS:
  -h, --help                Show this help
  --version                 Show version

EXAMPLES:
  # Desktop background
  macoz bg                              # Auto-select seasonal wallpaper
  macoz bg autumn                       # Random autumn wallpaper
  macoz bg autumn 02                    # Specific seasonal wallpaper
  macoz bg ~/Pictures/wallpaper.jpg     # Custom image

  # Folder icons
  macoz setpicfor icon.png              # Set icon for current directory
  macoz setpicfor photo.jpg ~/Projects  # Set icon for specific directory
  macoz setpicfor --all                 # Set icons for all subdirectories with icon.*
  macoz setpicfor --all --dry-run       # Preview what would be changed
  macoz setpicfor --all --verbose       # Show detailed progress

SEASONS:
  spring, summer, autumn, winter

PLATFORM:
  Requires macOS

For detailed help, run: utilz help macoz
EOF
}

# ============================================================================
# MAIN
# ============================================================================

# Check platform
check_macos

# Parse command
if [[ $# -eq 0 ]]; then
    usage
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    background|bg)
        # Arguments are optional - will auto-select seasonal if not provided
        cmd_background "${1:-}" "${2:-}"
        ;;
    setpicfor)
        # Set folder icon from image file
        cmd_setpicfor "$@"
        ;;
    -h|--help)
        usage
        exit 0
        ;;
    --version)
        show_version "macoz"
        exit 0
        ;;
    *)
        error "Unknown command: $COMMAND"
        echo ""
        usage
        exit 1
        ;;
esac
