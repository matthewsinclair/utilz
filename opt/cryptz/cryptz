#!/usr/bin/env bash
#
# cryptz - GPG encryption and decryption utility
#

set -euo pipefail

# Source common functions if not already loaded (from dispatcher)
if [[ "$(type -t info 2>/dev/null)" != "function" ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    UTILZ_HOME="${UTILZ_HOME:-$(cd "$SCRIPT_DIR/../.." && pwd)}"

    if [[ -f "$UTILZ_HOME/opt/utilz/lib/common.sh" ]]; then
        source "$UTILZ_HOME/opt/utilz/lib/common.sh"
    else
        echo "ERROR: Cannot find common.sh library" >&2
        exit 1
    fi
fi

# ============================================================================
# CONFIGURATION
# ============================================================================

# Default recipient email (can be overridden with --email or CRYPTZ_EMAIL env var)
DEFAULT_EMAIL="${CRYPTZ_EMAIL:-matthew.sinclair@gmail.com}"

# ============================================================================
# COMMANDS
# ============================================================================

cmd_encrypt() {
    local input_file=""
    local output_file=""
    local email="$DEFAULT_EMAIL"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --email)
                email="$2"
                shift 2
                ;;
            *)
                if [[ -z "$input_file" ]]; then
                    input_file="$1"
                elif [[ -z "$output_file" ]]; then
                    output_file="$1"
                else
                    error "Too many arguments"
                    return 1
                fi
                shift
                ;;
        esac
    done

    # Validate input
    if [[ -z "$input_file" ]]; then
        error "No input file specified"
        return 1
    fi

    if [[ ! -f "$input_file" ]]; then
        error "Input file not found: $input_file"
        return 1
    fi

    # Default output filename
    if [[ -z "$output_file" ]]; then
        output_file="${input_file}.gpg"
    fi

    # Check for gpg
    require_command "gpg" "GPG is required for encryption (install with: brew install gnupg)"

    # Encrypt
    info "Encrypting $input_file to $output_file"
    info "Using recipient: $email"

    if gpg --output "$output_file" --encrypt --recipient "$email" "$input_file"; then
        success "File encrypted successfully: $output_file"
    else
        error "Encryption failed"
        return 1
    fi
}

cmd_decrypt() {
    local input_file=""
    local output_file=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            *)
                if [[ -z "$input_file" ]]; then
                    input_file="$1"
                elif [[ -z "$output_file" ]]; then
                    output_file="$1"
                else
                    error "Too many arguments"
                    return 1
                fi
                shift
                ;;
        esac
    done

    # Validate input
    if [[ -z "$input_file" ]]; then
        error "No input file specified"
        return 1
    fi

    if [[ ! -f "$input_file" ]]; then
        error "Input file not found: $input_file"
        return 1
    fi

    # Default output filename (strip .gpg extension)
    if [[ -z "$output_file" ]]; then
        output_file="${input_file%.gpg}"
        # If filename didn't end with .gpg, add .decrypted
        if [[ "$output_file" == "$input_file" ]]; then
            output_file="${input_file}.decrypted"
        fi
    fi

    # Check for gpg
    require_command "gpg" "GPG is required for decryption (install with: brew install gnupg)"

    # Decrypt
    info "Decrypting $input_file to $output_file"

    if gpg --output "$output_file" --decrypt "$input_file"; then
        success "File decrypted successfully: $output_file"
    else
        error "Decryption failed"
        return 1
    fi
}

# ============================================================================
# USAGE
# ============================================================================

usage() {
    cat <<EOF
Usage: cryptz <command> [options] <input> [output]

GPG encryption and decryption utility

COMMANDS:
  encrypt <input> [output]     Encrypt file with GPG
  decrypt <input> [output]     Decrypt GPG file

ENCRYPT OPTIONS:
  --email <address>            Recipient email (default: $DEFAULT_EMAIL)

GLOBAL OPTIONS:
  -h, --help                   Show this help
  --version                    Show version

EXAMPLES:
  # Encrypt file (creates file.txt.gpg)
  cryptz encrypt file.txt

  # Encrypt with custom output
  cryptz encrypt file.txt encrypted.gpg

  # Encrypt with specific recipient
  cryptz encrypt --email user@example.com file.txt

  # Decrypt file (strips .gpg extension)
  cryptz decrypt file.txt.gpg

  # Decrypt with custom output
  cryptz decrypt file.txt.gpg decrypted.txt

CONFIGURATION:
  Set CRYPTZ_EMAIL environment variable to change default recipient:
    export CRYPTZ_EMAIL="your@email.com"

For detailed help, run: utilz help cryptz
EOF
}

# ============================================================================
# MAIN
# ============================================================================

# Parse command
if [[ $# -eq 0 ]]; then
    usage
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    encrypt)
        cmd_encrypt "$@"
        ;;
    decrypt)
        cmd_decrypt "$@"
        ;;
    -h|--help)
        usage
        exit 0
        ;;
    --version)
        show_version "cryptz"
        exit 0
        ;;
    *)
        error "Unknown command: $COMMAND"
        echo ""
        usage
        exit 1
        ;;
esac
